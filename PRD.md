# Документ требований к продукту (PRD)
## LighthouseForCycles

**Версия:** 1.0  
**Дата:** 2026-01-26  
**Статус:** Черновик

---

## 1. Резюме

### 1.1 Обзор продукта
LighthouseForCycles — это приложение на Python, предназначенное для автоматизации камеры наблюдения: надо распознавать движущиеся объекты, измерять их скорость. Если скорость превышает допустимую - зажигать маяк (лампочку)

### 1.2 Описание проблемы
Безопасность дорожного движения для велосипедистов, электросамокатов и других СИМ (средства индивидуальной мобильности)

### 1.3 Обзор решения

1. Камера подключенная по USB
2. Лампочка или светодиод для включения
3. Контроллер: ноутбук или Raspberry Pi

---

## 2. Цели и задачи продукта

### 2.1 Основные цели
- Работа с камерой
- Распознавание нескольких объектов (до 5 штук)
- Определение скорости объектов
- Управление маяком при превышении скорости
- Калибровка системы для точных измерений
- Логирование и отчетность

### 2.2 Метрики успеха
- Система работает автономно, без участия человека
- Точность распознавания объектов ≥ 80%
- Точность измерения скорости ±5%
- Время отклика системы (от обнаружения до включения маяка) < 1 секунды
- Обработка до 5 объектов одновременно
- Стабильная работа на Raspberry Pi 3 (≥ 15 FPS обработки)

---

## 3. Целевые пользователи

### 3.1 Персоны пользователей
- **Основной пользователь:** Администратор
- **Вторичный пользователь:** Наблюдатель

### 3.2 Потребности пользователей
- Калибровка системы
- Базовая настройка
- Получение отчетов

---

## 4. Функциональные требования

### 4.1 Основные функции

#### Функция 1: Распознавание объектов на кадре
- **Описание:** Выделение крупных объектов на кадре: велосипед, мотороллер, самокат, моноколесо и подобные
- **Приоритет:** Высокий
- **Критерии приемки:**
  - Точность распознавания объектов ≥ 80%
  - Обработка до 5 объектов одновременно
  - Работа при различном освещении (день/ночь)
  - Распознавание объектов размером от 0.5м до 3м
  - Обработка объектов на краю кадра

#### Функция 2: Определение скорости объектов
- **Описание:** Для найденных объектов вычислить их скорость
- **Приоритет:** Высокий
- **Критерии приемки:**
  - Точность измерения скорости ±5%
  - Расчет для объектов размером от 0.5м до 3м
  - Определение скорости в диапазоне от 0 до 50 км/ч
  - Учет направления движения объекта

#### Функция 3: Управление маяком/лампочкой
- **Описание:** Включение/выключение светового сигнала при превышении скорости
- **Приоритет:** Высокий
- **Критерии приемки:**
  - Задержка реакции < 1 секунды от момента обнаружения превышения скорости
  - Возможность настройки длительности сигнала (от 1 до 30 секунд)
  - Поддержка GPIO для Raspberry Pi и USB-реле
  - Автоматическое выключение после заданного времени
  - Индикация состояния маяка в веб-интерфейсе

#### Функция 4: Калибровка системы
- **Описание:** Настройка зоны детекции и масштабирования для расчета скорости
- **Приоритет:** Средний
- **Критерии приемки:**
  - Веб-интерфейс для визуальной калибровки зоны детекции
  - Настройка масштабирования (пиксели → метры)
  - Сохранение параметров калибровки в конфигурационном файле
  - Возможность перекалибровки без перезапуска системы
  - Предустановленные шаблоны для типовых установок

#### Функция 5: Логирование и хранение данных
- **Описание:** Запись событий превышения скорости, статистики распознавания
- **Приоритет:** Средний
- **Критерии приемки:**
  - Структурированные логи в формате JSON
  - Хранение событий превышения скорости с временными метками
  - Статистика распознавания (количество объектов, точность)
  - Возможность экспорта данных в CSV/JSON
  - Ротация логов для предотвращения переполнения диска
  - Хранение данных в локальной базе данных (SQLite)

#### Функция 6: Веб-интерфейс
- **Описание:** Панель управления, просмотр статистики, настройки системы
- **Приоритет:** Средний
- **Критерии приемки:**
  - Адаптивный дизайн для работы с различных устройств
  - Просмотр видео потока в реальном времени
  - Настройка пороговых значений скорости
  - Просмотр статистики нарушений (графики, таблицы)
  - Калибровка системы через веб-интерфейс
  - Аутентификация для доступа к настройкам
  - Работа в реальном времени без задержек

### 4.2 Пользовательские истории
- Как администратор, я хочу настроить пороговую скорость, чтобы система реагировала на нужные нарушения
- Как администратор, я хочу откалибровать зону детекции, чтобы измерения были точными
- Как администратор, я хочу видеть статистику работы системы, чтобы оценить эффективность
- Как наблюдатель, я хочу видеть статистику нарушений, чтобы анализировать ситуацию
- Как наблюдатель, я хочу просматривать видео поток в реальном времени, чтобы контролировать работу системы
- Как система, я должна логировать все события превышения скорости, чтобы можно было провести анализ
- Как система, я должна обрабатывать ошибки подключения оборудования, чтобы продолжать работу при сбоях

---

## 5. Нефункциональные требования

### 5.1 Производительность
- Должно работать на одноплатном компьютере, таком как Raspberry Pi 3
- Обработка видео с частотой ≥ 15 FPS на Raspberry Pi 3
- Использование легковесных моделей ML для детекции объектов
- Оптимизация использования памяти (не более 1 ГБ RAM)
- Эффективная обработка кадров с использованием асинхронности

### 5.2 Безопасность
- Аутентификация для веб-интерфейса (базовая HTTP-аутентификация или токен)
- Защита от несанкционированного доступа к настройкам системы
- Безопасное хранение конфигурации (защита паролей и чувствительных данных)
- Валидация входных данных для предотвращения инъекций
- Ограничение доступа к API только для авторизованных пользователей

### 5.3 Масштабируемость
- Возможность работы с несколькими камерами (будущее расширение)
- Оптимизация для работы на Raspberry Pi 3 (ограниченные ресурсы)
- Модульная архитектура для легкого добавления новых функций
- Возможность горизонтального масштабирования (несколько экземпляров системы)

### 5.4 Удобство использования
- Веб-интерфейс для контроля и получения отчетов
- Интуитивно понятный интерфейс калибровки
- Логирование всех важных событий
- Подробная документация по установке и настройке
- Сообщения об ошибках на понятном языке

### 5.5 Надежность
- Обработка ошибок подключения камеры (автоматическое переподключение)
- Восстановление после сбоев (автоматический перезапуск критических компонентов)
- Graceful shutdown при остановке системы (корректное завершение всех процессов)
- Проверка доступности оборудования при старте системы
- Обработка ошибок GPIO при работе с маяком
- Сохранение состояния системы для восстановления после перезапуска
- Мониторинг работоспособности компонентов

### 5.6 Условия эксплуатации
- Работа при различном освещении (день/ночь, с подсветкой)
- Работа в различных погодных условиях (дождь, снег - с ограничениями по видимости)
- Температурный диапазон работы оборудования: от -10°C до +50°C
- Стабильная работа при непрерывной эксплуатации 24/7
- Защита от перегрева оборудования

### 5.7 Пример веб-интерфейса

```
┌─────────────────────────────────────────────────────────────────┐
│ LighthouseForCycles - Панель управления                          │
│ Статус: [● АКТИВНА] | Камера: [● ONLINE] | Маяк: [● ВКЛ]       │
│ FPS: 18 | Объектов: 2 | Нарушений сегодня: 5                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ ┌───────────────────────────────────────────────────────────┐ │
│ │ ВИДЕОПОТОК С КАМЕРЫ                                        │ │
│ │ ┌─────────────────────────────────────────────────────┐   │ │
│ │ │                                                       │   │ │
│ │ │  [Зона детекции: ████████████████████]              │   │ │
│ │ │                                                       │   │ │
│ │ │  Объект #1: [██] 25 км/ч ✓                          │   │ │
│ │ │  Объект #2: [██] 18 км/ч ✓                          │   │ │
│ │ │                                                       │   │ │
│ │ └─────────────────────────────────────────────────────┘   │ │
│ │                                                             │ │
│ │ [Пауза] [Снимок] [Настройки камеры]                        │ │
│ └───────────────────────────────────────────────────────────┘ │
│                                                                   │
│ ┌──────────────────────┐  ┌──────────────────────┐             │
│ │ Статус системы       │  │ Быстрые действия     │             │
│ │                      │  │                      │             │
│ │ Камера:     [ONLINE] │  │ [Калибровка]         │             │
│ │ Маяк:       [ВКЛ]    │  │ [Настройки]          │             │
│ │ FPS:        18       │  │ [Экспорт данных]     │             │
│ │ Объектов:   2        │  │ [Перезапуск]         │             │
│ │ Нарушений:  5        │  │                      │             │
│ └──────────────────────┘  └──────────────────────┘             │
│                                                                   │
│ ┌───────────────────────────────────────────────────────────┐ │
│ │ Последние события                                          │ │
│ │ ┌───────────────────────────────────────────────────────┐ │ │
│ │ │ 14:32:15 | Объект #3 | 32 км/ч | ⚠ ПРЕВЫШЕНИЕ        │ │ │
│ │ │ 14:28:42 | Объект #1 | 22 км/ч | ✓                   │ │ │
│ │ │ 14:25:18 | Объект #2 | 28 км/ч | ✓                   │ │ │
│ │ │ 14:20:05 | Объект #1 | 35 км/ч | ⚠ ПРЕВЫШЕНИЕ        │ │ │
│ │ └───────────────────────────────────────────────────────┘ │ │
│ │ [Показать все] [Экспорт в CSV]                              │ │
│ └───────────────────────────────────────────────────────────┘ │
│                                                                   │
│ ┌───────────────────────────────────────────────────────────┐ │
│ │ Статистика за сегодня                                      │ │
│ │ Всего объектов: 127 | Нарушений: 5 (3.9%)                 │ │
│ │ Средняя скорость: 18 км/ч | Макс. скорость: 42 км/ч       │ │
│ │ [График] [Таблица] [Экспорт]                                │ │
│ └───────────────────────────────────────────────────────────┘ │
│                                                                   │
│ [Главная] [Калибровка] [Настройки] [Статистика] [Логи] [Выход]  │
└─────────────────────────────────────────────────────────────────┘
```

**Основные элементы интерфейса:**
- **Верхняя панель:** Статус системы, индикаторы подключения оборудования, ключевые метрики
- **Видеопоток:** Отображение кадра с камеры в реальном времени, зона детекции, обнаруженные объекты с их скоростью
- **Панель статуса:** Текущее состояние компонентов системы
- **Быстрые действия:** Кнопки для основных операций
- **События:** Лента последних обнаружений с отметками о превышении скорости
- **Статистика:** Сводка за день с возможностью просмотра графиков и экспорта данных
- **Навигация:** Доступ к основным разделам интерфейса

---

## 6. Технические требования

### 6.1 Технологический стек
- **Язык программирования:** Python 3.13+
- **Компьютерное зрение:** OpenCV для обработки видео и работы с камерой
- **ML/Детекция объектов:** YOLO (легковесная версия) или аналогичная модель для Raspberry Pi
- **Веб-фреймворк:** FastAPI или Flask для веб-интерфейса и API
- **GPIO управление:** RPi.GPIO или gpiozero для управления лампочкой (для Raspberry Pi)
- **База данных:** SQLite для локального хранения событий и статистики
- **Асинхронность:** asyncio для параллельной обработки видео и управления оборудованием
- **Тестирование:** pytest, pytest-cov
- **Качество кода:** black, flake8, mypy
- **Конфигурация:** JSON/YAML файлы для настроек системы

### 6.2 Архитектура
- Модульная архитектура с разделением на компоненты:
  - **Модуль захвата видео (Camera):** работа с USB-камерой, захват кадров
  - **Модуль детекции объектов (ObjectDetection):** распознавание объектов на кадре с использованием ML модели
  - **Модуль расчета скорости (SpeedCalculation):** вычисление скорости объектов на основе их перемещения
  - **Модуль управления маяком (LighthouseController):** управление световым сигналом через GPIO/USB-реле
  - **Модуль веб-интерфейса (WebInterface):** предоставление API и веб-страниц для управления и мониторинга
  - **Модуль логирования и хранения (DataStorage):** запись событий, статистики в базу данных и логи
- Асинхронная обработка кадров для обеспечения производительности
- Очередь событий для управления маяком (предотвращение конфликтов при одновременных срабатываниях)
- Разделение ответственности между модулями для упрощения тестирования и поддержки

### 6.3 Интеграция с оборудованием
- **Камера USB:** 
  - Поддержка стандартных USB-камер (UVC совместимые)
  - Автоматическое определение устройства при старте
  - Настройка разрешения и частоты кадров
  - Обработка ошибок подключения и переподключения
- **Лампочка/Светодиод:** 
  - GPIO для Raspberry Pi (12V реле или прямое подключение через транзистор)
  - USB-реле для универсальности (поддержка различных платформ)
  - WiFi-устройства (будущее расширение)
  - Конфигурируемые порты и параметры управления
- **Конфигурация:** 
  - JSON/YAML файл для настроек системы
  - Возможность изменения параметров без перезапуска (hot reload для некритичных настроек)
  - Валидация конфигурации при загрузке

---

## 7. Ограничения и предположения

### 7.1 Ограничения
- Работа только с одной камерой в первой версии
- Требуется статичная установка камеры (без движения, фиксированное положение)
- Необходима калибровка для каждой точки установки
- Работает только с объектами, движущимися в определенной зоне детекции
- Зависимость от качества камеры и освещения (низкое качество снижает точность)
- Ограничения производительности Raspberry Pi 3 (может потребоваться оптимизация модели или использование более мощного оборудования)
- Работает только с объектами определенного размера (от 0.5м до 3м)
- Требуется достаточное освещение для работы в ночное время (или подсветка)
- Ограничения по погодным условиям (сильный дождь, снег могут снижать точность)

### 7.2 Предположения
- Камера установлена статично и направлена на зону контроля
- Доступно стабильное питание для оборудования (220V или USB питание)
- Пользователь имеет базовые навыки настройки системы (работа с веб-интерфейсом)
- Зона детекции имеет достаточное освещение (днем или с подсветкой ночью)
- Оборудование защищено от внешних воздействий (корпус, защита от влаги)
- Доступ к системе для настройки и мониторинга (локальная сеть или интернет)

---

## 8. Вне области видимости

Следующие функции не будут реализованы в первой версии продукта:

- Распознавание конкретных типов СИМ (только общее распознавание объектов)
- Работа с несколькими камерами одновременно
- Интеграция с внешними системами (базы данных нарушений, системы уведомлений)
- Мобильное приложение для управления системой
- Облачное хранение данных и синхронизация
- Автоматическая отправка уведомлений (email, SMS, push)
- Работа с камерами высокого разрешения (4K+)
- Видеозапись нарушений с сохранением фрагментов
- Распознавание номерных знаков или идентификация конкретных объектов
- Интеграция с системами контроля доступа
- Машинное обучение на основе собранных данных для улучшения точности

---

## 9. Временные рамки и вехи

### 9.1 Фазы разработки

- **Фаза 1: Базовая функциональность (MVP)**
  - Захват видео с камеры
  - Базовое распознавание объектов
  - Расчет скорости объектов
  - Управление маяком при превышении скорости
  - Срок: [указать]

- **Фаза 2: Калибровка и настройка**
  - Веб-интерфейс для калибровки зоны детекции
  - Сохранение конфигурации
  - Настройка пороговых значений скорости
  - Базовый веб-интерфейс для управления
  - Срок: [указать]

- **Фаза 3: Логирование и отчетность**
  - Система логирования событий
  - Хранение данных в базе данных
  - Веб-интерфейс для просмотра статистики
  - Экспорт данных (CSV/JSON)
  - Срок: [указать]

### 9.2 Ключевые вехи

- **Milestone 1:** Работающий прототип с базовым распознаванием объектов - [дата]
- **Milestone 2:** Интеграция с оборудованием (камера + маяк) - [дата]
- **Milestone 3:** Веб-интерфейс и калибровка - [дата]
- **Milestone 4:** Полная система с логированием и отчетностью - [дата]

---

## 10. Риски и меры по их снижению

### 10.1 Технические риски

- **Риск:** Низкая производительность на Raspberry Pi 3
  - **Влияние:** Задержки в обработке, пропуск кадров, снижение точности измерений
  - **Меры:** Использование легковесных моделей ML (YOLO-tiny), оптимизация кода, использование асинхронной обработки, возможность использования более мощного оборудования (Raspberry Pi 4)

- **Риск:** Неточность распознавания объектов
  - **Влияние:** Ложные срабатывания или пропуск нарушений, снижение доверия к системе
  - **Меры:** Тщательная калибровка системы, настройка пороговых значений, тестирование в реальных условиях, итеративная доработка модели распознавания

- **Риск:** Проблемы с подключением оборудования
  - **Влияние:** Система не работает, потеря функциональности
  - **Меры:** Проверка доступности оборудования при старте, автоматическое переподключение при сбоях, обработка ошибок, подробное логирование проблем, graceful degradation (работа без маяка при его недоступности)

- **Риск:** Проблемы с освещением в ночное время
  - **Влияние:** Снижение точности распознавания, невозможность работы в темноте
  - **Меры:** Использование ИК-подсветки, настройка параметров камеры для работы в условиях низкой освещенности, четкие требования к условиям установки

### 10.2 Бизнес-риски

- **Риск:** Недостаточная точность для практического применения
  - **Влияние:** Система не решает поставленную задачу, низкая эффективность
  - **Меры:** Прототипирование и тестирование на ранних этапах, итеративная доработка, установка реалистичных ожиданий, возможность ручной настройки параметров

- **Риск:** Сложность установки и настройки для конечных пользователей
  - **Влияние:** Низкое принятие системы, необходимость технической поддержки
  - **Меры:** Подробная документация, пошаговые инструкции, упрощенный процесс калибровки через веб-интерфейс, видео-руководства

---

## 11. Зависимости

### 11.1 Внешние зависимости

- **OpenCV библиотека** для работы с видео и обработки изображений
- **ML модель для детекции объектов** (YOLO или аналог) - предобученная модель
- **Python библиотеки для GPIO** (RPi.GPIO или gpiozero) - для Raspberry Pi
- **Веб-фреймворк** (FastAPI или Flask) для создания веб-интерфейса
- **База данных SQLite** (встроенная в Python)
- **Библиотеки для работы с асинхронностью** (asyncio, aiohttp при необходимости)

### 11.2 Внутренние зависимости

- **Стабильная работа камеры USB** - наличие совместимого устройства
- **Доступность GPIO портов** - для Raspberry Pi (для управления маяком)
- **Стабильное питание оборудования** - необходимое для непрерывной работы
- **Достаточное освещение** - для качественного распознавания объектов
- **Стабильное интернет-соединение** (опционально) - для удаленного доступа к веб-интерфейсу

---

## 12. Приложение

### 12.1 Глоссарий

- **СИМ (Средства индивидуальной мобильности):** велосипеды, электросамокаты, моноколеса и подобные транспортные средства
- **Маяк:** световой сигнал (лампочка или светодиод), предупреждающий о превышении скорости
- **Калибровка:** процесс настройки системы для точного определения скорости объектов в конкретной точке установки
- **Зона детекции:** область в кадре камеры, где происходит распознавание и измерение скорости объектов
- **GPIO (General Purpose Input/Output):** универсальные порты ввода/вывода на одноплатных компьютерах
- **FPS (Frames Per Second):** количество кадров в секунду, обрабатываемых системой
- **YOLO (You Only Look Once):** алгоритм детекции объектов на изображении
- **UVC (USB Video Class):** стандарт для USB-видеоустройств

### 12.2 Ссылки

- [OpenCV документация](https://docs.opencv.org/)
- [YOLO модель для детекции объектов](https://github.com/ultralytics/yolov5)
- [Raspberry Pi GPIO документация](https://www.raspberrypi.org/documentation/usage/gpio/)
- [FastAPI документация](https://fastapi.tiangolo.com/)
- [Python asyncio документация](https://docs.python.org/3/library/asyncio.html)

---

## История документа

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2026-01-26 | [Автор] | Первоначальный черновик |
